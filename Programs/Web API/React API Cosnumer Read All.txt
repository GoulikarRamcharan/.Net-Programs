import React, { useState, useEffect, useCallback } from 'react';

// --- API Configuration ---
// IMPORTANT:
// REPLACE THIS URL with the actual endpoint of your running .NET Core API.
// Example: 'http://localhost:5000/api/students' or 'https://yourserver.com/api/students'
const API_URL = 'https://jsonplaceholder.typicode.com/users'; // Using a public mock API for demonstration

/**
 * @typedef {Object} Student
 * @property {number} Id
 * @property {number} Stno
 * @property {string} Stname
 * @property {string} Doa
 * @property {number} Fees
 */

// --- Main Application Component ---
const App = () => {
  const [jsonResponse, setJsonResponse] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [fetchTrigger, setFetchTrigger] = useState(0);

  const fetchData = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    setJsonResponse('');

    try {
      console.log(`Attempting to fetch data from: ${API_URL}`);
      const response = await fetch(API_URL);

      if (!response.ok) {
        // Handle HTTP errors (4xx or 5xx)
        throw new Error(`HTTP error! Status: ${response.status} (${response.statusText})`);
      }

      // Parse the JSON response
      const data = await response.json();
      
      // Convert the JSON object back to a pretty-printed string for display
      const prettyJson = JSON.stringify(data, null, 2);
      setJsonResponse(prettyJson);

    } catch (err) {
      console.error("Fetch error:", err.message);
      setError(err.message || 'An unknown network error occurred. Check the console for details.');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Fetch data on initial mount and when fetchTrigger changes
  useEffect(() => {
    fetchData();
  }, [fetchData, fetchTrigger]);

  const handleRefresh = () => {
    setFetchTrigger(prev => prev + 1);
  };

  const renderContent = () => {
    if (isLoading) {
      return (
        <div className="flex justify-center items-center p-8 bg-white rounded-xl shadow-inner">
          <svg className="animate-spin h-6 w-6 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p className="text-xl text-gray-600 font-medium">Fetching JSON data from API...</p>
        </div>
      );
    }

    if (error) {
      return (
        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md mt-4">
          <p className="font-bold">Connection Error</p>
          <p className="text-sm mt-1">{error}</p>
          <p className="text-xs mt-2 font-mono">
             Ensure your .NET Core API is running and the CORS policy is correctly configured to allow requests from this frontend (e.g., using `AllowAnyOrigin()` as shown in your C# code).
          </p>
        </div>
      );
    }

    if (jsonResponse) {
      return (
        <div className="bg-gray-900 p-4 rounded-xl shadow-2xl transition-all duration-300">
          <div className="flex items-center space-x-2 mb-3">
            <span className="h-3 w-3 bg-red-500 rounded-full"></span>
            <span className="h-3 w-3 bg-yellow-500 rounded-full"></span>
            <span className="h-3 w-3 bg-green-500 rounded-full"></span>
          </div>
          <pre className="text-sm sm:text-base text-green-300 overflow-x-auto whitespace-pre-wrap max-h-[70vh] font-mono p-1">
            {jsonResponse}
          </pre>
        </div>
      );
    }
    
    // Default state if not loading and no error, but data not yet fetched/empty response
    return (
        <div className="p-8 text-center text-gray-500 bg-white rounded-xl shadow-lg">
            <p className="text-xl font-semibold">Ready to Fetch</p>
            <p className="mt-2 text-sm">Press "Refresh Data" to load records from: <code className="font-mono text-indigo-600">{API_URL}</code></p>
        </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-8 font-sans transition-colors duration-500">
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />
      <style>{`
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
      `}</style>

      <div className="max-w-4xl mx-auto">
        <header className="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white rounded-xl shadow-lg">
          <div className="mb-4 sm:mb-0">
            <h1 className="text-3xl font-extrabold text-indigo-800 leading-tight">
              API JSON Data Viewer
            </h1>
            <p className="text-sm text-gray-500 mt-1">
                Fetching data from: <code className="font-mono text-sm text-indigo-600 break-all">{API_URL}</code>
            </p>
          </div>
          
          <button
            onClick={handleRefresh}
            disabled={isLoading}
            className={`flex items-center px-6 py-3 border border-transparent text-base font-semibold rounded-lg shadow-xl transition transform duration-200 ease-in-out
              ${isLoading 
                ? 'bg-indigo-300 text-white cursor-not-allowed' 
                : 'bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-75'
              }`}
          >
            {isLoading ? (
              <>
                <svg className="animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading...
              </>
            ) : (
              <>
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 12m15.356 0A8.001 8.001 0 0120 12.001v5h-.582m-15.356-2A8.001 8.001 0 0019.418 12m-15.356 0a8.001 8.001 0 01-1.884 2.809M12 21V9" />
                </svg>
                Refresh Data
              </>
            )}
          </button>
        </header>

        {renderContent()}
      </div>
    </div>
  );
};

export default App;
